<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
	<meta name="generator" content="LibreOffice 7.4.4.2 (Linux)"/>
	<meta name="created" content="00:00:00"/>
	<meta name="changed" content="00:00:00"/>
	<style type="text/css">
		@page { size: 8.27in 11.69in; margin: 0.79in }
		p { line-height: 115%; margin-bottom: 0.1in; background: transparent }
		pre { font-family: "Liberation Mono", monospace; font-size: 10pt; background: transparent }
	</style>
</head>
<body lang="en-US" link="#000080" vlink="#800000" dir="ltr"><pre>АВТОРИЗАЦИЯ

В ФормеОбъекта справочника &quot;Пользователи&quot;:

&amp;НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	Запрос=Новый Запрос;
	Запрос.Текст = &quot;ВЫБРАТЬ
			|	Пользователи.Логин КАК Логин,
			|	Пользователи.УникальныйИдентификатор КАК УникальныйИдентификатор
			|ИЗ
			|	Справочник.Пользователи КАК Пользователи
			|ГДЕ
			|	Пользователи.Логин = &amp;Логин&quot;;
	Запрос.УстановитьПараметр(&quot;Логин&quot;, Объект.Логин);
	
	Результат = Запрос.Выполнить().Выбрать();
		
	Попытка
		НовыйПользователь = ПользователиИнформационнойБазы.СоздатьПользователя();
		НовыйПользователь.Имя = Объект.Логин;
		НовыйПользователь.Пароль = Объект.Пароль;
		НовыйПользователь.ПолноеИмя = Объект.Наименование;
		Если Объект.Роль = Перечисления.Роли.Администратор Тогда
			НовыйПользователь.Роли.Добавить(Метаданные.Роли.Администратор);
		ИначеЕсли Объект.Роль = Перечисления.Роли.Водитель Тогда
			НовыйПользователь.Роли.Добавить(Метаданные.Роли.Водитель);
		ИначеЕсли Объект.Роль = Перечисления.Роли.Менеджер Тогда
			НовыйПользователь.Роли.Добавить(Метаданные.Роли.Менеджер);
		ИначеЕсли Объект.Роль = Перечисления.Роли.Мастер Тогда
			НовыйПользователь.Роли.Добавить(Метаданные.Роли.Мастер);
        КонецЕсли; 
				НовыйПользователь.Записать();
	Исключение
		Сообщить(&quot;Ошибка записи нового пользователя&quot;);			
	КонецПопытки;
КонецПроцедуры



МОБИЛКА

В ФормеДокумента документа &quot;Заказ&quot;:

&amp;НаКлиенте
Процедура УсловияДоставкиПриИзменении(Элемент)
	Если Объект.Доставка = Истина Тогда
		Элементы.АдресДоставки.Видимость = Истина;
	Иначе
		Элементы.АдресДоставки.Видимость = Ложь;
	КонецЕсли;
КонецПроцедуры

&amp;НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	СтрокаТЧ = Элементы.Товары.ТекущиеДанные;
	СтрокаТЧ.Сумма = СтрокаТЧ.Количество * СтрокаТЧ.Цена;
КонецПроцедуры

&amp;НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	СтрокаТЧ = Элементы.Товары.ТекущиеДанные;
	СтрокаТЧ.Сумма = СтрокаТЧ.Количество * СтрокаТЧ.Цена;
КонецПроцедуры

---

В модуле объекта документа &quot;Заказ&quot;:

Процедура ПриЗаписи(Отказ)
	Если Доставка = Истина Тогда
		Статус = Перечисления.СтатусыЗаказов.ВДоставку;
	КонецЕсли;
КонецПроцедуры

Процедура ПриУстановкеНовогоНомера(СтандартнаяОбработка, Префикс)
	Статус = Перечисления.СтатусыЗаказов.Новый
КонецПроцедуры

---

В модуле объекта документа &quot;Доставка&quot;:

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	//{{__КОНСТРУКТОР_ВВОД_НА_ОСНОВАНИИ
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	Если ТипЗнч(ДанныеЗаполнения) = Тип(&quot;ДокументСсылка.Заказ&quot;) и ДанныеЗаполнения.Доставка = ИСТИНА Тогда
		// Заполнение шапки
		АдресДоставки = ДанныеЗаполнения.АдресДоставки;
		Клиент = ДанныеЗаполнения.Клиент;
		Заказ = ДанныеЗаполнения.Ссылка;
		СуммаЗаказа = ДанныеЗаполнения.Товары.Итог(&quot;Сумма&quot;);
		Для Каждого ТекСтрокаТовары Из ДанныеЗаполнения.Товары Цикл
			НоваяСтрока = Товары.Добавить();
			НоваяСтрока.Количество = ТекСтрокаТовары.Количество;
			НоваяСтрока.Товар = ТекСтрокаТовары.Товар;
		КонецЦикла;
	Иначе  
        ВызватьИсключение(&quot;Доставка не может быть назначена для данного документа&quot;);
	КонецЕсли;
	//}}__КОНСТРУКТОР_ВВОД_НА_ОСНОВАНИИ
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Если Доставлен = Истина Тогда
		
		ЗаказДоставки = ЭтотОбъект.Заказ.ПолучитьОбъект();
		ЗаказДоставки.Статус = Перечисления.СтатусыЗаказов.Закрыт;
		
	КонецЕсли;
	
КонецПроцедуры

---

В модуле Web-сервиса Exchange:

Функция PostData()
	ОтветСервера = Новый Структура();
	Попытка
		    ЗапросДоставка = Новый Запрос;
			ЗапросДоставка.Текст = &quot;ВЫБРАТЬ
			                       |	ДоставкаТовары.Товар.Наименование КАК Товар,
			                       |	ДоставкаТовары.Количество КАК Количество,
			                       |	ДоставкаТовары.Ссылка.Номер КАК Номер,
			                       |	ДоставкаТовары.Ссылка.Дата КАК Дата,
			                       |	ДоставкаТовары.Ссылка.Клиент.Наименование КАК Клиент,
			                       |	ДоставкаТовары.Ссылка.АдресДоставки КАК АдресДоставки,
			                       |	ДоставкаТовары.Ссылка.СуммаЗаказа КАК СуммаЗаказа,
			                       |	УНИКАЛЬНЫЙИДЕНТИФИКАТОР(ДоставкаТовары.Ссылка) КАК УИД
			                       |ИЗ
			                       |	Документ.Доставка.Товары КАК ДоставкаТовары
			                       |ГДЕ
			                       |	ДоставкаТовары.Ссылка.Проведен = ИСТИНА
			                       |	И ДоставкаТовары.Ссылка.Доставлен = ЛОЖЬ&quot;;
			ОтветСервера.Вставить(&quot;Ответ&quot;, ЗапросДоставка.Выполнить().Выгрузить());
			Возврат ОбменДанными.Сериализовать(ОтветСервера)
	Исключение
		    ОтветСервера = Новый Структура(&quot;Ответ&quot;, ОписаниеОшибки());
		Возврат ОбменДанными.Сериализовать(ОтветСервера);
	КонецПопытки;	
КонецФункции 

Функция GetData(GetData)
	ОтветСервера = Новый Структура;
	Если ЗначениеЗаполнено(GetData) Тогда
			ПолученныеДанные = ОбменДанными.Десериализовать(GetData);
	КонецЕсли;
	Попытка
		Доставка = Документы.Доставка.ПолучитьСсылку(ПолученныеДанные.Данные).ПолучитьОбъект();
		Доставка.Доставлен = ИСТИНА;
		Доставка.Записать(РежимЗаписиДокумента.Проведение);
		ОтветСервера.Вставить(&quot;Ответ&quot;, &quot;Данные успешно доставлены&quot;);
		Возврат ОбменДанными.Сериализовать(ОтветСервера)
	Исключение
		ОтветСервера.Вставить(&quot;Ответ&quot;, ОписаниеОшибки());
		Возврат ОбменДанными.Сериализовать(ОтветСервера)
	КонецПопытки;
КонецФункции

---

В общем модуле ОбменДанными (ЦБ) / Служебный (МБ):

Функция Сериализовать(Объект) Экспорт 
	
	ДеревоВОбъекте = СериализаторXDTO.ЗаписатьXDTO(Объект);
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку();
	ФабрикаXDTO.ЗаписатьXML(ЗаписьXML, ДеревоВОбъекте);
	
	Возврат ЗаписьXML.Закрыть();
	
КонецФункции 

Функция Десериализовать(XMLСтруктура) Экспорт

	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.УстановитьСтроку(XMLСтруктура);
	ТЗ = СериализаторXDTO.ПрочитатьXML(ЧтениеXML);
	
	Возврат ТЗ
	
КонецФункции

---

В модуле объекта документа &quot;Доставка&quot; (мобилка):

Процедура ОбработкаПроведения(Отказ, РежимПроведения)

	Если Доставлен = ИСТИНА Тогда
		
		Попытка
			
			Данные = Новый Структура(&quot;Данные&quot;, ЭтотОбъект.Ссылка.УникальныйИдентификатор());
			
			//обращение к веб-сервису
			Соединение = WSСсылки.Exchange.СоздатьWSПрокси(&quot;Exchange&quot;,&quot;Exchange&quot;,&quot;ExchangeSoap&quot;);
			ОтветСервера = Соединение.GetData(Служебный.Сериализовать(Данные));
			
			Ответ = Служебный.Десериализовать(ОтветСервера); 
			Сообщить(Ответ);	
		Исключение
		Сообщить(ОписаниеОшибки());	
		КонецПопытки;
				
	КонецЕсли;

КонецПроцедуры

---
В команде &quot;ПроверитьНовые&quot; модуля ФормыСписка документа &quot;Доставка&quot; (мобилка):


&amp;НаСервере
Процедура ПроверитьНовыеНаСервере()
	Попытка
			//обращение к веб-сервису
			Соединение = WSСсылки.Exchange.СоздатьWSПрокси(&quot;Exchange&quot;,&quot;Exchange&quot;,&quot;ExchangeSoap&quot;);
			ОтветСервера = Соединение.PostData();
			
			ОтветТЗ = Служебный.Десериализовать(ОтветСервера);
			
			//создание документов
			ЗапросОтветТЗ = Новый Запрос;
			ЗапросОтветТЗ.Текст = &quot;ВЫБРАТЬ
			                      |	ОтветТЗ.Товар КАК Товар,
			                      |	ОтветТЗ.Количество КАК Количество,
			                      |	ОтветТЗ.Номер КАК Номер,
			                      |	ОтветТЗ.Дата КАК Дата,
			                      |	ОтветТЗ.Клиент КАК Клиент,
			                      |	ОтветТЗ.АдресДоставки КАК АдресДоставки,
			                      |	ОтветТЗ.СуммаЗаказа КАК СуммаЗаказа,
			                      |	ОтветТЗ.УИД КАК УИД
			                      |ПОМЕСТИТЬ ВТ
			                      |ИЗ
			                      |	&amp;ОтветТЗ КАК ОтветТЗ
			                      |;
			                      |
			                      |////////////////////////////////////////////////////////////////////////////////
			                      |ВЫБРАТЬ
			                      |	ВТ.Товар КАК Товар,
			                      |	ВТ.Количество КАК Количество,
			                      |	ВТ.Номер КАК Номер,
			                      |	ВТ.Дата КАК Дата,
			                      |	ВТ.Клиент КАК Клиент,
			                      |	ВТ.АдресДоставки КАК АдресДоставки,
			                      |	ВТ.СуммаЗаказа КАК СуммаЗаказа,
			                      |	ВТ.УИД КАК УИД
			                      |ИЗ
			                      |	ВТ КАК ВТ
			                      |ИТОГИ ПО
			                      |	УИД&quot;;
			ЗапросОтветТЗ.УстановитьПараметр(&quot;ОтветТЗ&quot;, ОтветТЗ.Ответ);
			ВыборкаУИД = ЗапросОтветТЗ.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаУИД.Следующий() Цикл
				
				ДокДоставка = Документы.Доставка.ПолучитьСсылку(ВыборкаУИД.УИД);
				Если ДокДоставка = Документы.Доставка.ПустаяСсылка() Или СтрНайти(Строка(ДокДоставка), &quot;Объект не найден&quot;)&gt;0 Тогда
					
					НовДоставка = Документы.Доставка.СоздатьДокумент();
					Ссылка = Документы.Доставка.ПолучитьСсылку(ВыборкаУИД.УИД);
					НовДоставка.УстановитьСсылкуНового(Ссылка);
					
					
					Выборка = ВыборкаУИД.Выбрать();
					Пока Выборка.Следующий() Цикл
						
						НовДоставка.Дата = Выборка.Дата;
						НовДоставка.Клиент = Выборка.Клиент;
						НовДоставка.АдресДоставки = Выборка.АдресДоставки;
						НовДоставка.СуммаЗаказа = Выборка.СуммаЗаказа;
						СтрТЧ = НовДоставка.Товары.Добавить();
						СтрТЧ.Товар = Выборка.Товар;
						СтрТЧ.Количество = Выборка.Количество;
						
					КонецЦикла;
					НовДоставка.Записать(РежимЗаписиДокумента.Запись);
				
				КонецЕсли;	
								
			КонецЦикла;
			Сообщить(&quot;Загружены новые документы&quot;);
			
		Исключение
			
			Сообщить(ОписаниеОшибки());
		КонецПопытки;

КонецПроцедуры

&amp;НаКлиенте
Процедура ПроверитьНовые(Команда)
	ПроверитьНовыеНаСервере();
КонецПроцедуры

---

Пример WSDL:
http://10.28.90.4/DemoCB/ws/Exchange.1cws?wsdl

- http://10.28.90.4 – адрес веб-сервера, на котором опубликована база данных, 
содержащая web-сервис; 
- DemoCB/ – имя базы данных, используемое при ее публикации на веб-
сервере; 
- ws/ - указатель обращения к web-сервису; 
- Exchange.1cws – имя файла публикации web-сервиса; 
-?wsdl – указание о том, что описание web-сервиса опубликовано в формате 
WSDL (Web Service Definition Language). </pre>
</body>
</html>
